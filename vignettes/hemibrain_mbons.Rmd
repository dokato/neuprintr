---
title: "hemibrain msuhroom body output neurons"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{hemibrain_mbons}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

> "WHEN the systems approach can be connected to the mechanisms approach so that its feedback loop and automata becomes clothed in flesh and blood, we shall see real and exciting progress in understanding behaviour."
([Kenneth Roeder](https://www.springer.com/gp/book/9783642692734)

# Inspecting the hemibrain

The largest draft connectome to date was released on the 22nd of January, 2020. The [FlyEM Janelia HemiBrain project](https://www.janelia.org/project-team/flyem/hemibrain) has released 21,662 neurons, many more fragments, and almost 10 million synapses. About 35% of its automatically predicted synapses have been matched up to a semi-automatically traced 'body' deemed large enough to constitute an identifiable neuron. This data can be accessed using our R package [neuprintr](https://github.com/natverse/neuprintr/) to query a publically accessible [neuPrint explorer instance](https://neuprint.janelia.org/).

## Lock and load

```{r startup, eval = FALSE}
# install
if(!require('devtools')) install.packages("devtools")
if(!require('natverse')) devtools::install_github("natverse/natverse")
if(!require('ComplexHeatmap')) install.packages("ComplexHeatmap")
if(!require('ggnetwork')) install.packages("ggnetwork")
if(!require('network')) install.packages("network")

# load
library(natverse)
library(neuprintr)
library(dendroextras)
library(ComplexHeatmap)
library(ggnetwork)
library(network)

# Colours
## some nice colors!! Inspired by LaCroixColoR
lacroix = c("#C70E7B", "#FC6882", "#007BC3", "#54BCD1", "#EF7C12", "#F4B95A", 
            "#009F3F", "#8FDA04", "#AF6125", "#F4E3C7", "#B25D91", "#EFC7E6", 
            "#EF7C12", "#F4B95A", "#C23A4B", "#FBBB48", "#EFEF46", "#31D64D", 
            "#132157","#EE4244", "#D72000", "#1BB6AF")
names(lacroix) = c("purple", "pink",
                   "blue", "cyan",
                   "darkorange", "paleorange",
                   "darkgreen", "green",
                   "brown", "palebrown",
                   "mauve", "lightpink",
                   "orange", "midorange",
                   "darkred", "darkyellow",
                   "yellow", "palegreen", 
                   "navy","cerise",
                   "red", "marine")

## Then see if a simple function works for you:
available.datasets = neuprint_datasets()
available.datasets
```

If you need help/have not before logged into neuPrint via R, please see the package README or see \code{?neuprint_login}.

The main point is that To make life easier, you can then edit your R.environ file to contain information about the neuPrint server you want to speak with, your token and the dataset hosted by that server, that you want to read. You can use the package \code{usethis} to easily edit your R environ file. You will need to add this line to your R environ to specify the hemibrain dataset:

\code{neuprint_token = "YOUR_TOKEN_HERE"}
\code{neuprint_server = 'https://neuprint.janelia.org/'}
\code{neuprint_dataset = 'hemibrain:v1.0'}

Then restart your R session.

## Find neurons

![hemibrain_an_mbon](https://raw.githubusercontent.com/natverse/neuprintr/master/inst/images/hemibrain_an_mbon.png)

First, we need to find neurons to read from neuPrint. We can do this easily in two ways - we can search by name, and we can search by brain region.

So what do we want to look at? Perhaps we could look at some popular neuron types and see if they connect to each other? Mushroom body output neurons (MBONs) are a well-studied neuron class. They read-out stored associative memories, 'located' in the mushroom body of the flies. These mushroom bodies are split into compartments (e.g. a, alpha or y, gamma -- further split into gamma 1-5, for example). That have different learning properties. Their light-level anatomy and role in memory have been well probed [(Aso et al. 2014a,](https://www.ncbi.nlm.nih.gov/pubmed/25535793) [Aso et al. 2014b)](https://www.ncbi.nlm.nih.gov/pubmed/25535794).

Let's find some in our HemiBrain data:

```{r find.neurons, eval = FALSE}
### Let's find some in our HemiBrain data:
mbon.info = neuprint_search(".*MBON.*")
mbon.info[!is.na(mbon.info$type),"type"] = mbon.info[!is.na(mbon.info$type),"name"]
rownames(mbon.info) = mbon.info$bodyid
#### Add MB compartment information from the name
name.split = strsplit(mbon.info$name,split="\\(")
comps = sapply(name.split, function(x) tryCatch(gsub("\\)|_|bi.*|R.*|L.*|\\?.*|P.*","",x[[2]]), error = function(e) ""))
mbon.info$compartment = comps
mbon.info = subset(mbon.info, compartment!="")
#### so there seem to be
print(length(comps))
#### MBONs and
#### And
print(length(unique(comps)))
#### MBONs with unique compartment innervations
#### In the literature, there are 

## Let's see what meta-info we get, along with stuff with 'MBON' in the name
View(mbon.info)
### Looks like we get their unique ID numbers (bodyIds), cell names,
### types, their size (voxels) and synapse numbers (pre=output, post=input).

## Let's quickly read one neuron, and have a look at it!
mbon = neuprint_read_neuron(mbon.info$bodyid[1])
### visualise:
nopen3d(userMatrix = structure(c(0.591208934783936, 0.804114699363708, 
                                  0.0622238591313362, 0, -0.0341671295464039, -0.0521107465028763, 
                                  0.998056709766388, 0, 0.805794537067413, -0.592186093330383, 
                                  -0.00333413854241371, 0, 0, 0, 0, 1), .Dim = c(4L, 4L)), zoom = 0.710681617259979, 
         windowRect = c(20L, 65L, 1191L, 843L)) # set view
plot3d(mbon, WithConnectors = TRUE, col = lacroix[["brown"]], lwd = 2)
dir.create("images")
rgl.snapshot(filename = "images/hemibrain_an_mbon.png", fmt ="png")
### output synapses in red, input ones in blue
### You can see the auto-segmentation goes a bit crazy where the soma is

## Now that we have all of the bodyIds, we can read these neurons from neuPrint:
mbons = neuprint_read_neurons(mbon.info$bodyid)
nopen3d(userMatrix = structure(c(0.98370349407196, -0.104569993913174, 
                                 -0.146263062953949, 0, 0.147007316350937, -0.000597098842263222, 
                                 0.989135324954987, 0, -0.103521309792995, -0.994517505168915, 
                                 0.0147849693894386, 0, 0, 0, 0, 1), .Dim = c(4L, 4L)), zoom = 0.644609212875366, 
        windowRect = c(20L, 65L, 1191L, 843L))
plot3d(mbons, col = sample(lacroix,length(mbons), replace = TRUE), lwd = 2)
rgl.snapshot(filename = "images/hemibrain_mbons.png", fmt ="png")
### Why is this function so slow?
### Because it fetches fragmented neuron skeletons assigned to the same neuron
### Stitched them into one neuron, grabs all the neuron's synapses
### and tries to work out where the soma is. If you want to move faster
### You can grab bits separately and quickly:
?neuprint_read_neuron_simple
?neuprint_get_synapses
?neuprint_assign_connectors
?neuprint_locate_soma

## Do we have to know what's in the name to find interesting neurons? No!
### We can also read neurons from a region of interest (ROI) of the brain.
### The regions of interest available are:
rois = sort(neuprint_ROIs())
rois

## We don't we try fetching all of the neurons in a compartment of the mushroombody lobes?
### The compartment a'3 is interesting, because it is involved in aversive odour learning
### and novetly detection (Aso et al. 2014; Hattori et al. 2016)
ap3.info = neuprint_find_neurons(
  input_ROIs = "a'3(R)",
  output_ROIs = NULL,
  all_segments = FALSE # if true, fragments smaller than 'neurons' are returned as well
)

## So how many neurons is that?
print(nrow(ap3.info))

## A lot! But what about that pesky load of Kenyon cells
### The most populous neurons in the brain
ap3.info = subset(ap3.info, !is.na(bodyname) & neuronStatus == "Traced")
ap3.info = ap3.info[!grepl("KC",ap3.info$bodyname),]

## So how many neurons is that?
print(nrow(ap3.info))

## Getting all that data took a while, so let's save it for later
save(mbons,file = "hemibrain_mbons.rda")

```

![hemibrain_mbons_mb](https://raw.githubusercontent.com/natverse/neuprintr/master/inst/images/hemibrain_mbons_mb.png)

So, previously ~35 MBON cells were known (variable between brains) that fall into ~22 types [(Aso et al. 2014a,](https://www.ncbi.nlm.nih.gov/pubmed/25535793) [Aso et al. 2014b,](https://www.ncbi.nlm.nih.gov/pubmed/25535794) [Takemura et al. 2017)](https://www.ncbi.nlm.nih.gov/pubmed/28718765). Here, according to the naming in the hemibrain project, there are putative 75 MBON cells that can be broken down into ~35 putative types.

## Get neuropil volumes

So it is nice that we now have some neurons. But it would be good to see them with their neuropil context.

![hemibrain_MB_ap3](https://raw.githubusercontent.com/natverse/neuprintr/master/inst/images/hemibrain_MB_ap3.png)

Let's fetch some volume data to plot:

```{r neuropils, eval = FALSE}
## Let's get some neuropil volume data from neuPrint!
### Specifically, in the last R file we chose to look at MBONs
### So let's fetch their meshes for the mushroombody!
### First, we gotta see what is available:
rois = sort(neuprint_ROIs())
rois

# Read in the MB mesh!
mb.mesh = neuprint_ROI_mesh(roi = "MB(R)")
nopen3d(userMatrix = structure(c(0.947127282619476, 0.222770735621452, 
                                 -0.230919197201729, 0, 0.247805655002594, -0.0506941750645638, 
                                 0.967482566833496, 0, 0.203820571303368, -0.973551869392395, 
                                 -0.103217624127865, 0, 0, 0, 0, 1), .Dim = c(4L, 4L)), zoom = 0.58467960357666, 
        windowRect = c(1460L, 65L, 2877L, 996L)) # set view
plot3d(mb.mesh, add = TRUE, alpha = 0.1, col = lacroix[["pink"]])

# And highlight compartment alpha prime 3
ap3.mesh = neuprint_ROI_mesh(roi = "a'3(R)")
plot3d(ap3.mesh, add = TRUE, alpha = 0.5, col = lacroix[["purple"]])
rgl.snapshot(filename = "images/hemibrain_MB_ap3.png", fmt ="png")

## Maybe get the whole hemibrai mesh?
## hemibrain = neuprint_ROI_mesh(roi = "hemibrain")

# And with some neurons!
nopen3d(userMatrix = structure(c(0.98370349407196, -0.104569993913174, 
                                 -0.146263062953949, 0, 0.147007316350937, -0.000597098842263222, 
                                 0.989135324954987, 0, -0.103521309792995, -0.994517505168915, 
                                 0.0147849693894386, 0, 0, 0, 0, 1), .Dim = c(4L, 4L)), zoom = 0.644609212875366, 
        windowRect = c(20L, 65L, 1191L, 843L))
plot3d(mb.mesh, add = TRUE, alpha = 0.1, col = "grey")
plot3d(mbons, col = sample(lacroix,length(mbons), replace = TRUE), lwd = 2)
rgl.snapshot(filename = "images/hemibrain_mbons_mb.png", fmt ="png")
```

## Get connectivity

And now the really exciting bit! How do these neurons connect to each others?

First we will look at connectivity between MBON types. 

![mbon_compartment_connectivity](https://raw.githubusercontent.com/natverse/neuprintr/master/inst/images/mbon_compartment_connectivity.png)

Then we will follow up on their connectivity with other neurons in the brain, and focus on a 'teaching' dopaminergic input onto a MBON type, MBON-a'3, which is thought to allow this MBON to act as a novelty detector [(Hattori et al. 2017)](https://www.ncbi.nlm.nih.gov/pubmed/28502772).

![mbon_paths_to_PPL1ap3](https://raw.githubusercontent.com/natverse/neuprintr/master/inst/images/mbon_paths_to_PPL1ap3.png)

```{r connectivity, eval = FALSE}
## We are looking at connectivity between MBONs.
### We can get an adjaceny matrix between all of these MBONs
mbon.adj = neuprint_get_adjacency_matrix(bodyids = mbon.info$bodyid)
rownames(mbon.adj) = colnames(mbon.adj) = mbon.info$type

## Let's visualise this connectivity
my_palette <- colorRampPalette(c(lacroix[["cyan"]],lacroix[["yellow"]], lacroix[["orange"]], lacroix[["cerise"]])) (n=20)
pdf(file = "images/MBON_interconnectivity.pdf", height = 10, width = 10)
Heatmap(mbon.adj,
        col = my_palette)
dev.off()

## It is hard to parse this information mentally
### What if we just see what the compartment to compartment connectivity is?
mbon.adj.comp = mbon.adj
rownames(mbon.adj.comp) = colnames(mbon.adj.comp) = mbon.info$compartment
mbon.adj.comp = t(apply(t(mbon.adj.comp), 2, function(x) tapply(x, colnames(mbon.adj.comp), mean, na.rm = TRUE)))
mbon.adj.comp = apply(mbon.adj.comp, 2, function(x) tapply(x, rownames(mbon.adj.comp), mean, na.rm = TRUE))
pdf(file = "images/MBON_compartment_interconnectivity.pdf", height = 10, width = 10)
Heatmap(mbon.adj.comp,
        col = my_palette)
dev.off()

## What about MBON connectivity to neurons not in this set of MBONs?
### First, is there a common partner to all MBONs?
common = neuprint_common_connectivity(mbon.info$bodyid, prepost = "PRE") # could use 'post' for downstream
dim(common) # nope!
### What about all a'3 MBONs?
ap3.mbon.info = subset(mbon.info, grepl("a'3",name))
ap3.common = neuprint_common_connectivity(ap3.mbon.info$bodyid, prepost = "PRE")
dim(ap3.common) # so there are 25 common partners to the 4 MBONs
ap3.common.meta = neuprint_get_meta(colnames(ap3.common)) # what are they?
View(ap3.common.meta) # ooh of course, the dopamine input (DAN) to a'3 and other weird things, but no KCs!

## We can also get all of the neurons in the database that connect to the
### query neurons, either upstream or downstream of them
ap3.mbon.connected = neuprint_connection_table(ap3.mbon.info$bodyid, prepost = "POST")
### In which brain region are these partners?
table(ap3.mbon.connected$roi)

## Let's have a look at what the strongest downstream partners look like
ap3.mbon.connected.strong = subset(ap3.mbon.connected,weight>30, prepost = "POST")
ap3.targets = neuprint_read_neurons(ap3.mbon.connected.strong$partner)
ap3.targets = unspike(ap3.targets, threshold=1000)
nopen3d(userMatrix = structure(c(0.964227318763733, -0.0444099828600883, 
                                 -0.261329621076584, 0, 0.249727189540863, -0.178416073322296, 
                                 0.951737523078918, 0, -0.088891975581646, -0.982952415943146, 
                                 -0.160943150520325, 0, 0, 0, 0, 1), .Dim = c(4L, 4L)), zoom = 0.676839649677277, 
        windowRect = c(1440L, 45L, 2937L, 938L))
plot3d(ap3.targets, lwd = 2, sample(lacroix,length(ap3.targets),replace=TRUE))
rgl.snapshot(filename = "images/hemibrain_ap3_strong_downstream_partners.png", fmt ="png")
View(ap3.targets[,])

## Can other MBONs influence these strong partners?
### The cognate DAN for MBONs-a'3, PPL1-a'3, gets 49 (!) of its inputs from MBONs-a'3
### Which other MBONs impinge on it?
### Via whatever path?
shortest.paths = data.frame()
for(b in mbon.info$bodyid){
  sp = neuprint_get_shortest_paths(body_pre = b, body_post = "517514142")
  dupe = ifelse( is.na(which(duplicated(sp$to))[1]),nrow(sp),which(duplicated(sp$to))[1])
  shortest = sp[1:dupe,]
  if(nrow(shortest)>0 & ncol(shortest) > 0 & nrow(shortest)<5 ){
    shortest$order.to = paste(1:nrow(shortest), nrow(shortest), sep = "/")
    shortest$order.from = paste(1:nrow(shortest)-1, nrow(shortest), sep = "/")
    shortest[1,"order.from"] = mbon.info[as.character(b),"compartment"]
    shortest[nrow(shortest),"order.to"] = ap3.targets["517514142","type"]
    shortest.paths = rbind(shortest.paths, shortest) 
  }
}

# Make network
set.seed(42)
paths = aggregate(list(weight = shortest.paths$weight), list(order.from = shortest.paths$order.from,
                                                             order.to = shortest.paths$order.to),
                           sum)
n = network(paths,
            matrix.type = "edgelist",
            ignore.eval = FALSE,
            layout = "fruchtermanreingold",
            names.eval = "weight",
            directed = TRUE)
n %v% "width" <- ifelse(is.na(ggnetwork(n)$weight),0,ggnetwork(n)$weight)
n = ggnetwork(n, cell.jitter = 0.75, arrow.gap = 0.01)

# Set colours
orders = unique(c(paths$order.to,paths$order.from))
order.cols = rep("grey30",length(orders))
names(order.cols) = orders
comps = unique(mbon.info$compartment)
mbon.cols = rep(lacroix[["pink"]],length(comps))
names(mbon.cols) = comps
mbon.cols = c(mbon.cols,
              order.cols[!names(order.cols)%in%c("PPL104",names(mbon.cols))],
              "PPL104" = lacroix[["orange"]])

# Plot
set.seed(1)
pdf(file = "images/PPL1ap3_MBON_input_graph.pdf", height = 5, width = 5)
ggplot(n, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges(aes(color = vertex.names),
             curvature = 0.05,
             arrow = arrow(length = unit(6, "pt"), 
                           type = "closed")) +
  geom_nodes(aes(color = vertex.names, size = 6)) +
  geom_edgetext(aes(label = weight, color = vertex.names), fill = NA) +
  geom_nodelabel_repel(aes(color = vertex.names, label = vertex.names),
                       fontface = "bold", box.padding = unit(1, "lines")) +
  scale_color_manual(values = mbon.cols) +
  scale_fill_manual(values = mbon.cols) +
  theme_blank() +  
  guides(color = FALSE, shape = FALSE, fill = FALSE, size = FALSE, linetype = FALSE) + ylab("") + xlab("")
dev.off()
```

## Article

**A Connectome of the Adult
Drosophila Central
Brain**

Shan Xu, C; Januszewski, Michal; Lu, Zhiyuan; Takemura, Shin-Ya; Hayworth, Kenneth; Huang, Gary; Shinomiya, Kazunori; Maitin-Shepard, Jeremy; Ackerman, David; Berg, Stuart; Blakely, Tim; Bogovic, John; Clements, Jody; Dolafi, Tom; Hubbard, Philip; Kainmueller, Dagmar; Katz, William; Kawase, Takashi; Khairy, Khaled; Leavitt, Laramie; Li, Peter H; Lindsey, Larry; Neubarth, Nicole; Olbris, Donald J; Otsuna, Hideo; Troutman, Eric T; Umayam, Lowell; Zhao, Ting; Ito, Masayoshi; Goldammer, Jens; Wolff, Tanya; Svirskas, Robert; Schlegel, Philipp; Neace, Erika R; Knecht, Christopher J; Alvarado, Chelsea X; Bailey, Dennis; Ballinger, Samantha; Borycz, Jolanta A; Canino, Brandon; Cheatham, Natasha; Cook, Michael; Dreyer, Marisa; Duclos, Octave; Eubanks, Bryon; Fairbanks, Kelli; Finley, Samantha; Forknall, Nora; Francis, Audrey; Hopkins, Gary Patrick; Joyce, Emily M; Kim, Sungjin; Kirk, Nicole A; Kovalyak, Julie; Lauchie, Shirley A; Lohff, Alanna; Maldonado, Charli; Manley, Emily A; McLin, Sari; Mooney, Caroline; Ndama, Miatta; Ogundeyi, Omotara; Okeoma, Nneoma; Ordish, Christopher; Padilla, Nicholas; Patrick, Christopher; Paterson, Tyler; Phillips, Elliott E; Phillips, Emily M; Rampally, Neha; Ribeiro, Caitlin; Robertson, Madelaine K; Rymer, Jon Thomson; Ryan, Sean M; Sammons, Megan; Scott, Anne K; Scott, Ashley L; Shinomiya, Aya; Smith, Claire; Smith, Kelsey; Smith, Natalie L; Sobeski, Margaret A; Suleiman, Alia; Swift, Jackie; Takemura, Satoko; Talebi, Iris; Tarnogorska, Dorota; Tenshaw, Emily; Tokhi, Temour; Walsh, John J; Yang, Tansy; Horne, Jane Anne; Li, Feng; Parekh, Ruchi; Rivlin, Patricia K; Jayaraman, Vivek; Ito, Kei; Saalfeld, Stephan; George, Reed; Meinertzhagen, Ian; Rubin, Gerald M; Hess, Harald F; Scheffer, Louis K; Jain, Viren; Plaza, Stephen M

bioRxiv, Jan 21, 2020 [10.1101/2020.01.21.911859](https://www.biorxiv.org/content/10.1101/2020.01.21.911859v1)
